<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>LawBot Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .icon-btn {
      font-size: 20px;
      line-height: 1;
      padding: 6px 10px;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    .icon-btn:hover { background: #f1f5f9; border-radius: 50%; }

    /* ç»“æœé¢æ¿ï¼ˆé™é«˜+è‡ªåŠ¨æ”¶èµ·ï¼‰ */
    #uploadResult{
      display:none;
      margin:.5rem 0;
      padding:.5rem;
      background:#0f172a;
      color:#e2e8f0;
      white-space:pre-wrap;
      border:1px solid #1f2937;
      border-radius:6px;
      font-size:12px;
      max-height:160px;   /* é™é«˜ */
      overflow:auto;      /* è¶…å‡ºæ»šåŠ¨ */
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- å·¦ä¾§ä¼šè¯åˆ—è¡¨ -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="brand">LawBot Chat</div>
        <button id="new-chat" class="btn btn-primary">ï¼‹ New Chat</button>
      </div>

      <div class="sidebar-body">
        <div class="message-box">
          <button id="toggle-library" class="lib-toggle">
            Library <span id="lib-count" class="lib-count">(0)</span>
            <span class="chev">â–¾</span>
          </button>

          <div id="library-panel" class="library-panel">
            <div id="library-list" class="library-list">ï¼ˆå±•å¼€åè‡ªåŠ¨åŠ è½½â€¦ï¼‰</div>
          </div>
        </div>

        <div class="session-container">
          <div class="session-header">Chats</div>
          <div id="session-list" class="session-list"></div>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <main id="main">
      <header class="chat-header">
        <div class="chat-title">LawBot â€¢ AI assistance</div>
        <div class="chat-sub"></div>
        <button class="icon-btn" title="æŸ¥çœ‹æ•°æ®æ›´æ–°è®°å½•" onclick="window.location.href='/updates/'">ğŸ””</button>
      </header>

      <section id="messages" class="messages"></section>

      <!-- ä¸Šä¼ ç»“æœï¼ˆä¼šè‡ªåŠ¨æ”¶èµ·ï¼‰ -->
      <pre id="uploadResult"></pre>

      <!-- åº•éƒ¨è¾“å…¥æ¡ï¼šä¸Šä¼ æŒ‰é’®åœ¨è¾“å…¥æ¡†å·¦è¾¹ -->
      <footer id="composer" style="display:flex; align-items:flex-end; gap:.5rem;">
        <button id="upload-btn-inline" class="btn" style="white-space:nowrap;">Upload Files</button>
        <textarea id="q" rows="2" placeholder="Type your question..." style="flex:1;"></textarea>
        <div class="actions">
          <button id="send" class="btn btn-primary">Send</button>
        </div>
      </footer>
    </main>
  </div>

  <!-- åˆ é™¤ä¼šè¯ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="confirm" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">Delete Chatï¼Ÿ</div>
      <div class="modal-sub">The messages in this conversation will be permanently deleted and cannot be recovered.</div>
      <div class="modal-actions">
        <button id="confirm-cancel" class="btn">Cancel</button>
        <button id="confirm-ok" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- éšè—æ–‡ä»¶è¾“å…¥ -->
  <input id="upload-input" type="file" accept="application/pdf" multiple style="display:none;">

  <script src="/static/app.js?v=ref-click-1"></script>

  <!-- ä¸Šä¼ é€»è¾‘ï¼šæˆåŠŸåæ˜¾ç¤ºç®€çŸ­ä¿¡æ¯ï¼Œ3 ç§’è‡ªåŠ¨éšè— -->
  <script>
    (function () {
      const input = document.getElementById('upload-input');
      const btn = document.getElementById('upload-btn-inline');
      const out  = document.getElementById('uploadResult');

      function openPicker() { if (input) input.click(); }

      async function uploadFiles(files) {
        if (!files || !files.length) return;
        const fd = new FormData();
        for (const f of files) fd.append('files', f);

        out.style.display = 'block';
        out.textContent = 'Uploading...';

        try {
          const res = await fetch('/api/upload/', { method: 'POST', body: fd });
          const json = await res.json();

          const filesCnt = (json.saved || []).length;
          const chunksCnt = (json.ingested || []).reduce((s, x) => s + (x.chunks || 0), 0);
          out.textContent = `Uploaded ${filesCnt} file(s), ${chunksCnt} chunk(s) ingested.`;

          // å¯é€‰ï¼šåˆ·æ–° Library
          if (typeof window.refreshLibrary === 'function') window.refreshLibrary();

          setTimeout(() => { out.style.display = 'none'; }, 3000);
        } catch (err) {
          out.textContent = 'Upload failed: ' + err;
          setTimeout(() => { out.style.display = 'none'; }, 4000);
        }
      }

      if (btn) btn.addEventListener('click', openPicker);
      if (input) input.addEventListener('change', (e) => { uploadFiles(e.target.files); input.value=''; });
    })();
  </script>
</body>
</html>
