<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>LawBot Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .icon-btn {
      font-size: 20px;
      line-height: 1;
      padding: 6px 10px;
      border: none;
      background: transparent;
      cursor: pointer;
    }
    .icon-btn:hover { background: #f1f5f9; border-radius: 50%; }

    /* â†‘å³ä¾§é“ƒé“›æŒ‰é’®ä¿ç•™ */

    /* ===== å·¦ä¾§ä¸ŠåŠåŒºåˆå¹¶å—ï¼šLibrary + User Library ===== */
    .resources-box{
      flex: 0 0 30%;              /* ä¸ŠåŠåŒºå å·¦æ çš„ä¸€åŠ */
      padding: 12px 12px 0;
      overflow-y: auto;           /* åªåœ¨è¿™å±‚æ»šåŠ¨ï¼Œå†…éƒ¨ä¸å†å‡ºç°ç¬¬äºŒä¸ªæ»šåŠ¨æ¡ */
      border-bottom: 1px dashed var(--border);
      background: #fff;
    }

    /* Library æ ‡é¢˜æ ·å¼ï¼ˆä¸ Chats é£æ ¼ç»Ÿä¸€ï¼‰ */
    .lib-toggle{
      width: 100%;
      text-align: left;
      padding: 8px 16px 6px;
      background: #fff;
      border: none;
      border-bottom: 1px dashed var(--border);
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      display: flex; align-items: center; justify-content: space-between;
    }
    .lib-toggle .chev{ transition: transform .2s; color: var(--muted); }
    .lib-toggle .chev.up{ transform: rotate(180deg); }
    .lib-count{ margin-left: 6px; color: var(--muted); font-weight: 400; }

    /* Library å†…å®¹ï¼ˆä¸æ»šåŠ¨ï¼Œè·Ÿéšä¸Šå±‚æ»šåŠ¨ï¼‰ */
    .library-panel{ max-height:0; overflow:hidden; transition:max-height .25s ease, padding .25s ease; padding:0 16px; }
    .library-panel.open{ max-height:260px; padding:6px 16px 10px; }
    .library-list{ display:flex; flex-direction:column; gap:6px; }
    .library-list .lib-item{ text-decoration:none; color:#1e40af; font-weight:500; font-size:14px; line-height:1.5; }
    .library-list .lib-item:hover{ text-decoration:underline; }

    /* ===== User Library å°æ ·å¼ï¼ˆä¸ä½ ç°æœ‰ä¸€è‡´ï¼‰ ===== */
    .user-lib-header {
      display:flex; align-items:center; gap:.5rem;
      width:100%; padding:.6rem 1rem .4rem 1rem;
      background:#fff; border:none; border-bottom:1px dashed var(--border);
      font-weight:700; cursor:pointer; font-size:15px; color:var(--text);
      justify-content: space-between;
    }
    .user-lib-header .count { color:#6b7280; font-weight:500; }
    .user-lib-header .chev { margin-left:auto; }
    .user-lib-panel { margin:.5rem 0 .75rem; padding: 0 16px; }
    .user-lib-list .lib-item{
      display:flex; align-items:center; justify-content:space-between;
      gap:.5rem; padding:.55rem .75rem; margin:.4rem 0;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    }
    .user-lib-list .lib-link{ color:#2563eb; text-decoration:none; word-break:break-all; }
    .user-lib-list .lib-link:hover{ text-decoration: underline; }
    .btn-icon.trash{ background:transparent; border:none; cursor:pointer; font-size:16px; }
    .muted{ color:#9ca3af; padding:.5rem .25rem; }

    /* ä¸Šä¼ ç»“æœé¢æ¿ï¼ˆé™é«˜+è‡ªåŠ¨æ”¶èµ·ï¼‰ */
    #uploadResult{
      display:none;
      margin:.5rem 0;
      padding:.5rem;
      background:#0f172a;
      color:#e2e8f0;
      white-space:pre-wrap;
      border:1px solid #1f2937;
      border-radius:6px;
      font-size:12px;
      max-height:160px;
      overflow:auto;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <div class="brand">LawBot Chat</div>
        <button id="new-chat" class="btn btn-primary">ï¼‹ New Chat</button>
      </div>

      <div class="sidebar-body">
        <!-- âœ… ä¸ŠåŠï¼šæŠŠ Library + User Library åˆå¹¶åˆ°åŒä¸€å— -->
        <div class="resources-box">
          <!-- Libraryï¼ˆæŠ˜å ï¼‰ -->
          <button id="toggle-library" class="lib-toggle">
            <span>Library</span>
            <span id="lib-count" class="lib-count">(0)</span>
            <span class="chev">â–¾</span>
          </button>
          <div id="library-panel" class="library-panel">
            <div id="library-list" class="library-list">ï¼ˆå±•å¼€åè‡ªåŠ¨åŠ è½½â€¦ï¼‰</div>
          </div>

          <!-- User Libraryï¼ˆæŠ˜å ï¼‰ -->
          <button id="toggle-user-library" class="user-lib-header">
            <span>User Library</span>
            <span id="user-library-count" class="count">(0)</span>
            <span class="chev">â–¾</span>
          </button>
          <div id="user-library-panel" class="user-lib-panel">
            <div id="user-library-list" class="user-lib-list"></div>
          </div>
        </div>

        <!-- âœ… ä¸‹åŠï¼šä¼šè¯åˆ—è¡¨ï¼ˆChats ä»å å·¦ä¾§çš„ä¸€åŠï¼‰ -->
        <div class="session-container">
          <div class="session-header">Chats</div>
          <div id="session-list" class="session-list"></div>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§èŠå¤©ä¸»åŒº -->
    <main id="main">
      <header class="chat-header">
        <div class="chat-title">LawBot â€¢ AI assistance</div>
        <div class="chat-sub"></div>
        <button class="icon-btn" title="æŸ¥çœ‹æ•°æ®æ›´æ–°è®°å½•" onclick="window.location.href='/updates/'">ğŸ””</button>
      </header>

      <section id="messages" class="messages"></section>

      <!-- ä¸Šä¼ ç»“æœï¼ˆä¼šè‡ªåŠ¨æ”¶èµ·ï¼‰ -->
      <pre id="uploadResult"></pre>

      <!-- åº•éƒ¨è¾“å…¥æ¡ï¼šä¸Šä¼ æŒ‰é’®åœ¨è¾“å…¥æ¡†å·¦è¾¹ -->
      <footer id="composer" style="display:flex; align-items:flex-end; gap:.5rem;">
        <button id="upload-btn-inline" class="btn" style="white-space:nowrap;">Upload Files</button>
        <textarea id="q" rows="2" placeholder="Type your question..." style="flex:1;"></textarea>
        <div class="actions">
          <button id="send" class="btn btn-primary">Send</button>
        </div>
      </footer>
    </main>
  </div>

  <!-- åˆ é™¤ä¼šè¯ç¡®è®¤ï¼ˆåŸæœ‰ï¼‰ -->
  <div id="confirm" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">Delete Chatï¼Ÿ</div>
      <div class="modal-sub">The messages in this conversation will be permanently deleted and cannot be recovered.</div>
      <div class="modal-actions">
        <button id="confirm-cancel" class="btn">Cancel</button>
        <button id="confirm-ok" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- éšè—æ–‡ä»¶è¾“å…¥ -->
  <input id="upload-input" type="file" accept="application/pdf" multiple style="display:none;">

  <!-- ä½ é¡¹ç›®åŸæœ‰å‰ç«¯é€»è¾‘ -->
  <script src="/static/app.js?v=merge-lib"></script>

  <!-- ä¸Šä¼ é€»è¾‘ï¼ˆæˆåŠŸååˆ·æ–° User Libraryï¼‰ -->
  <script>
    (function () {
      const input = document.getElementById('upload-input');
      const btn   = document.getElementById('upload-btn-inline');
      const out   = document.getElementById('uploadResult');

      function openPicker() { input && input.click(); }

      async function uploadFiles(files) {
        if (!files || !files.length) return;
        const fd = new FormData();
        for (const f of files) fd.append('files', f);

        out.style.display = 'block';
        out.textContent = 'Uploading...';

        try {
          const res  = await fetch('/api/upload/', { method: 'POST', body: fd });
          const json = await res.json();

          const filesCnt  = (json.saved || []).length;
          const chunksCnt = (json.ingested || []).reduce((s, x) => s + (x.chunks || 0), 0);
          out.textContent = `Uploaded ${filesCnt} file(s), ${chunksCnt} chunk(s) ingested.`;

          // åˆ·æ–° User Library
          if (typeof window.refreshUserLibrary === 'function') window.refreshUserLibrary();

          setTimeout(() => { out.style.display = 'none'; }, 3000);
        } catch (err) {
          out.textContent = 'Upload failed: ' + err;
          setTimeout(() => { out.style.display = 'none'; }, 4000);
        }
      }

      btn && btn.addEventListener('click', openPicker);
      input && input.addEventListener('change', (e) => { uploadFiles(e.target.files); input.value=''; });
    })();
  </script>

  <!-- User Libraryï¼šæ¸²æŸ“/åˆ é™¤ + è®°ä½å±•å¼€çŠ¶æ€ï¼ˆé»˜è®¤å±•å¼€ï¼‰ -->
  <script>
    (function () {
      const listEl    = document.getElementById('user-library-list');
      const panel     = document.getElementById('user-library-panel');
      const toggleBtn = document.getElementById('toggle-user-library');
      const countEl   = document.getElementById('user-library-count');
      const KEY       = 'ui:userLibOpen';

      function setChev(open) {
        const chev = toggleBtn.querySelector('.chev');
        if (chev) chev.textContent = open ? 'â–¾' : 'â–¸';
      }
      function setOpen(open) {
        panel.style.display = open ? 'block' : 'none';
        setChev(open);
        localStorage.setItem(KEY, open ? '1' : '0');
        if (open) refreshUserLibrary();
      }

      async function refreshUserLibrary() {
        try {
          const res  = await fetch('/api/user-library/');
          const json = await res.json();
          const items = json.items || [];
          countEl.textContent = `(${items.length})`;

          listEl.innerHTML = '';
          if (!items.length) {
            listEl.innerHTML = '<div class="muted">No files</div>';
            return;
          }

          for (const it of items) {
            const li = document.createElement('div');
            li.className = 'lib-item';
            li.innerHTML = `
              <a class="lib-link" href="/static/${it.filename}" target="_blank" rel="noopener">${it.filename}</a>
              <button class="btn-icon trash" title="Delete" data-fn="${it.filename}">ğŸ—‘ï¸</button>
            `;
            listEl.appendChild(li);
          }
        } catch (err) {
          listEl.innerHTML = `<div style="padding:6px;color:#ef4444;">Load failed: ${err}</div>`;
        }
      }

      // åˆ é™¤ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
      listEl.addEventListener('click', async (e) => {
        const btn = e.target.closest('button.trash');
        if (!btn) return;
        const fn = btn.dataset.fn;
        if (!confirm(`Delete ${fn}?`)) return;
        try {
          const r = await fetch(`/api/upload/delete/?filename=${encodeURIComponent(fn)}`, { method: 'DELETE' });
          const j = await r.json();
          if (r.ok) {
            btn.parentElement.remove();
            const left = listEl.querySelectorAll('.lib-item').length;
            countEl.textContent = `(${left})`;
          } else {
            alert('Delete failed: ' + (j.error || r.status));
          }
        } catch (err) {
          alert('Delete failed: ' + err);
        }
      });

      // æŠ˜å æŒ‰é’®
      toggleBtn.addEventListener('click', () => {
        const open = panel.style.display === 'none';
        setOpen(open);
      });

      // â€”â€” åˆå§‹åŒ–ï¼šé»˜è®¤å±•å¼€ï¼›å¦‚è®°å¿†ä¸ºæ”¶èµ·åˆ™æŒ‰è®°å¿† â€”â€” //
      const saved = localStorage.getItem(KEY);
      const shouldOpen = (saved === null) ? true : (saved === '1');
      setOpen(shouldOpen);

      // æš´éœ²åˆ·æ–°å‡½æ•°ï¼Œä¾¿äºä¸Šä¼ æˆåŠŸåè°ƒç”¨
      window.refreshUserLibrary = refreshUserLibrary;
    })();
  </script>
</body>
</html>
